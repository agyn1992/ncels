@using System.Linq.Dynamic
@using System.Web.Mvc.Html
@using PW.Ncels.Database.Constants
@using PW.Ncels.Database.DataModel
@using PW.Ncels.Database.Recources
@model PW.Ncels.Database.DataModel.OBK_AssessmentDeclaration
@Html.Partial("~/Views/Home/MessageDialogBox.cshtml")

<style type="text/css">
    .CSSTableGenerator thead tr, .disabletd {
        color: #707070;
        font-weight: normal;
        background: #f2f2f2;
        background-color: #f3f3f3;
        background-image: -moz-linear-gradient(top,#f8f8f8,#ececec);
        background-image: -webkit-gradient(linear,0 0,0 100%,from(#f8f8f8),to(#ececec));
        background-image: -webkit-linear-gradient(top,#f8f8f8,#ececec);
        background-image: -o-linear-gradient(top,#f8f8f8,#ececec);
        background-image: linear-gradient(to bottom,#f8f8f8,#ececec);
        background-repeat: repeat-x;
        margin-bottom: 20px;
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#fff8f8f8',endColorstr='#ffececec',GradientType=0);
    }

    .CSSTableGenerator thead tr td {
        border-left: 1px solid gray;
    }
</style>
<link href="~/Content/css/plugins/jquery-ui/jquery-ui.css" rel="stylesheet" type="text/css" />
<style type="text/css">
    .select2-container {
        width: 100%;
    }

    .edit-control {
        width: 100%;
    }

    .ui-dialog {
        background: white;
    }

    .ui-dialog-titlebar-close {
        background: #08e7d2;
    }

    .ui-widget-header {
        border: 1px solid #08e7d2;
        background: #004d86;
        color: #ffffff;
        font-weight: bold;
    }

    .ui-dialog .ui-dialog-buttonpane button {
        background-color: #5cb85c;
        border-color: #4cae4c;
        color: white;
        padding: 5px 10px;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
    }
    /* Меню */

    #OBKmenuConteiner {
        width: 150px;
        float: left;
        margin-right: 5px;
        min-height: 50px;
        position: fixed;
        z-index: 9999;
        top: 20%;
    }

    .main-control {
    }
</style>
<link href="~/Content/css/plugins/select2/select2.css" rel="stylesheet" type="text/css" />
<link href="~/Content/css/plugins/chosen/chosen.css" rel="stylesheet" type="text/css" />
<link href="~/Content/css/custom/subform-comment-style.css" rel="stylesheet" type="text/css" />

<input type="hidden" value="@Model.ObjectId" id="modelId" />
@Html.HiddenFor(model => model.OwnerId)

<div class="ibox-content">

    <div class="row root-page" id="mainPage">
        <div class="col-lg-12">
            <div class="tabs-container">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#tab-1">Общие сведения</a></li>
                    <li class=""><a data-toggle="tab" href="#tab-2">Заявка</a></li>
                    <li class=""><a data-toggle="tab" href="#tab-3">Информация о заявляемой продукции</a></li>
                    <li class=""><a data-toggle="tab" href="#tab-4">Соглашение</a></li>
                </ul>
                <div class="tab-content">
                    <div id="tab-1" class="tab-pane active">
                        @Html.Partial("~/Views/SafetyAssessment/MainView.cshtml", @Model)
                    </div>
                    <div id="tab-2" class="tab-pane">
                        @Html.Partial("~/Views/SafetyAssessment/RequestView.cshtml", @Model)
                    </div>
                    <div id="tab-3" class="tab-pane">
                        @Html.Partial("~/Views/SafetyAssessment/ProductView.cshtml", new OBK_RS_Products())
                    </div>
                    <div id="tab-4" class="tab-pane">
                        @Html.Partial("~/Views/SafetyAssessment/AgreementView.cshtml", @Model)
                    </div>                
                </div>
            </div>
        </div>
    </div>
    <div class="row root-page" id="attachPage" style="display: none">
        <div class="panel-body">
            <h3 class="m-t-none m-b">3. Вложения</h3>
            <p class="text-bold">Прикрепите необходимые файлы ниже</p>
            <div id="attachDeclarationDiv">
                <attach-edit metadata="true" showcomment="true" history="true" url="/Upload/GetAttachListEdit?excludeCodes=0" type="@CodeConstManager.ATTACH_DRUG_FILE_CODE" path="@Model.Id" />
            </div>
        </div>
    </div>
</div>
<script src="~/Scripts/js/plugins/select2/select2.js"></script>
<script src="~/Scripts/js/plugins/select2/select2_locale_ru.js"></script>
<script src="~/Scripts/js/plugins/chosen/chosen.js"></script>
<script src="~/Scripts/js/plugins/chosen/chosen.jquery.js"></script>
<script src="~/Scripts/js/custom/subform-comment.js"></script>
<script src="~/Scripts/js/custom/atach-comment.js"></script>
<script type="text/javascript">
    function showRootPage(btnId, contentId) {
        $('#' + btnId).on('click', function () {
            if ($("#" + contentId).is(':visible')) {
                return;
            }
            if ($("#" + contentId).hasClass('disabled')) {
                return;
            }
            $("#drugTitle").text($("#" + btnId).text());

            $(".root-page").hide();
            $("#" + contentId).show();
        });
    }
    $(function () {
        $('#OBKmenuConteiner').show();
        $('#OBKmenuSlideBtn').on('click', function () {
            if (!$("#OBKmenuConteiner").hasClass('hidemenu')) {
                $("#OBKmenuConteiner").animate({ "left": "-110px" }).addClass('hidemenu');
            } else {
                $("#OBKmenuConteiner").animate({ "left": "0" }).removeClass('hidemenu');
            }
        });
        showRootPage("OBKdrugDeclarationBtn", "mainPage"); //главная страница
        showRootPage("OBKdrugAttachBtn", "attachPage"); // документы
        showRootPage("OBKdrugHistoryBtn", "historyPage"); // исполнение этапов
        showRootPage("OBKremarkBtn", "remarkPage");
        showRootPage("OBKcorespondenceBtn", "corespondencePage");
        showRootPage("OBKconclusionBtn", "conclusionPage");
    });

    function DeleteRecord(code, recordId) {
        $.ajax({
            type: "POST",
            url: '@Url.Action("DeleteRecord")',
            data: { 'code': code, 'recordId': recordId },
            dataType: 'json',
            cache: false,
            success: function (data) {
            },
            error: function (data) {
                alert("1Error" + data);
            }
        });
    }

    function showInformIcon(isShow) {
        if (isShow) {
            $('.input-group-addon').show();
        } else {
            $('.input-group-addon').hide();
        }
    }

    function changeFieldList(control, code) {
        $(control).change(function () {
            var controlId = $(this).attr('id');
            var type = "string";
            if ($(this).attr('typeField') != null) {
                type = $(this).attr('typeField');
            }
            var fieldDisplay = $(this).val();
            var fieldValue = $(this).val();

            if ($(this).is("select")) {
                fieldDisplay = $(this).find('option:selected').text();
            }
            if ($(this).is(":checkbox")) {
                fieldValue = $(this).prop('checked');
                if ($(this).prop('checked')) {
                    fieldDisplay = "Да";
                } else {
                    fieldDisplay = "Нет";
                }
            }
            if ($(this).hasClass("select2-offscreen") && $(this).select2('data') != null) {
                fieldDisplay = $(this).select2('data').text;
            }
            var row = $(this).closest('tr');
            var entityId;
            if (row != null) {
                entityId = row.attr('rowid');
            }
            UpdateModel(code, entityId, null, controlId, fieldValue, type, fieldDisplay);
        });
    }

    function showHidenCommentBtn() {
        if ($("#HideInform").val() === "hide") {
            $("#HideInformText").text("Показать примечание");
            $("#HideInform").val("show");
            $("#HideInformCheck").addClass("glyphicon-unchecked");
            $("#HideInformCheck").removeClass("glyphicon-check");
            showInformIcon(false);
        } else {
            $("#HideInformText").text("Скрыть примечание");
            $("#HideInform").val("hide");
            $("#HideInformCheck").removeClass("glyphicon-unchecked");
            $("#HideInformCheck").addClass("glyphicon-check");
            showInformIcon(true);
        }
    }

    function UpdateModel(code, recordId, fieldId, fieldName, fieldValue, type, fieldDisplay) {
        if (type === "float") {
            if (fieldValue != null && fieldValue.length > 0) {
                fieldValue = replaceAll(' ', '', fieldValue);
                if (fieldValue.indexOf(',') > 0) {
                    fieldValue = fieldValue.replace(',', '.');
                }
                if (fieldValue !== '' && !$.isNumeric(fieldValue)) {
                    showWarning('@ResourceSetting.sInputNumberRequired');
                    $('#' + fieldId).val("");
                    return false;
                }
                if (fieldValue.indexOf('-') > -1) {
                    showWarning('@ResourceSetting.enterNumberNotMinus');
                    $('#' + fieldId).val("");
                    return false;
                }
            }
        }
        if (type === "long") {
            if (fieldValue != null && fieldValue.length > 0) {
                if (fieldValue.indexOf(',') > 0 || fieldValue.indexOf('.') > 0) {
                    showWarning("Введите целое число");
                    $('#' + fieldId).val("");
                    return false;
                }
                if (fieldValue !== '' && !$.isNumeric(fieldValue)) {
                    showWarning('@ResourceSetting.sInputNumberRequired');
                    $('#' + fieldId).val("");
                    return false;
                }
                if (fieldValue.indexOf('-') > -1) {
                    showWarning('@ResourceSetting.enterNumberNotMinus');
                    $('#' + fieldId).val("");
                    return false;
                }
            }
        }

        var modelId = $("#modelId").val();
        var userId = $("#OwnerId").val();
        if (modelId === null || modelId.length === 0) {
            modelId = null;
            window.Showbusy(event);
        }
        $.ajax({
            type: "POST",
            url: '@Url.Action("UpdateModel")',
            data: {
                'code': code,
                'modelId': modelId,
                'userId': userId,
                'recordId': recordId,
                'fieldName': fieldName,
                'fieldValue': fieldValue,
                'fieldDisplay': fieldDisplay
            },
            dataType: 'json',
            cache: false,
            success: function (data) {
                if (modelId === null) {
                    $("#modelId").val(data.modelId);
                    $("#drugAttachBtn").removeClass('disabled');
                    $("#loading").hide();
                }
                if (data.recordId > 0) {
                    var row = $('#' + fieldName).parent().closest('tr');
                    row.attr("rowid", data.recordId);
                    $('#' + fieldName).attr('id', data.controlId);
                }
            },
            error: function (data) {
                alert("1Error" + data);
            }
        });
    }


    $("#typeIds").on("change", function () {
        if ($('#typeIds').val()) {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetAttachListEdit", "Upload", new { id = Model.Id, type = @CodeConstManager.ATTACH_DRUG_FILE_CODE, excludeCodes = 0 })',
                success: function(result) {
                    $("#loading").hide();           
                }
            });
        }});

    $(document).ready(function () {
        $("#HideInform").click(function () {
            showHidenCommentBtn();
        });
        //  $("#wrapPage").hide();
        // $("#tab-2").addClass("active");
        /*
        $('#wrapLabelPage').click(function () {
            $("#wrapPage").show();
        });*/
        $("div.chzn-select select").chosen({ width: '100%' });

        // $('.chzn-drop').css({ "width": "300px" });
        //    $(".chzn-select-deselect").chosen({ allow_single_deselect: true });

    });
</script>




