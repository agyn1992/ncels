@using Kendo.Mvc.Extensions
@using Microsoft.Ajax.Utilities
@using Quartz.Util
@model PW.Ncels.Database.DataModel.OBK_AssessmentDeclaration

@{
    var @modelId = Model.Id;
    var @expertiseStartDate = DateTime.Now.ToShortDateString();
    var @invoiceContractRu = @Model.InvoiceContractRu ?? " ";
    var @invoiceContractKz = @Model.InvoiceContractKz ?? " ";
    var @invoiceRu = @Model.InvoiceRu ?? " ";
    var @invoiceKz = @Model.InvoiceKz ?? " ";
    var @invoiceDate = @Model.InvoiceDate != null ? @Model.InvoiceDate.ToString() : " ";
}
<style>
    .pw-row-selected {
        background-color: #beebff !important;
    }
</style>

<div class="panel-body">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Информация о продукции
                </div>
                <div>
                    <button type="button" style="margin: 10px" class="btn btn-default"><span class="pwToolbarButtonReview"></span><span class="pwToolbarButtonTitle">Перевести на следующий этап</span></button>                    
                </div>
                <div class="panel-body">
                    <table class="table table-striped table-bordered table-hover dataTable" dt-columns="dtColumns" dt-options="dtOptions" id="tableExpertiseProducts_@modelId" width="100%"></table>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    Информация о заявлемой продукции
                </div>
                <div class="panel-body" id="productExpertiseId">
                    <div class="row" style="margin-bottom: 10px">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <div class="col-lg-12">
                                    <table id="tableExpertiseProductSeries_@modelId" dt-options="dtOptions" dt-columns="dtColumns" class="table table-striped table-bordered table-hover dataTable" width="100%"></table>
                                </div>
                            </div>
                            <div id="resultRowId" style="display: block">
                                <div class="form-group">
                                    <div class="col-lg-6">
                                        <label class="control-label">Результат</label>
                                        @Html.DropDownList("ExpertiseResult", (IEnumerable<SelectListItem>)ViewData["UObkExpertiseResult"],
                                            String.Empty, new { @class = "form-control" })
                                    </div>
                                    <div class="col-lg-3">
                                        <label class="control-label">Дата регистрации:</label>
                                        <input class="form-control date-control" type="text" id="expertiseStartDate" value="@expertiseStartDate">
                                    </div>

                                    <div class="col-lg-3">
                                        <label class="control-label">Дата истечения:</label>
                                        <input class="form-control date-control" type="text" id="expertiseEndDate">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-lg-11">
                                        <label class="control-label">Основание</label>
                                        @Html.DropDownList("ReasonResult", Enumerable.Empty<SelectListItem>(), String.Empty, new { @class = "form-control" })
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-lg-6">
                                        <label class="control-label">Основание на русском языке*</label>
                                        <textarea rows="4" id="expReasonNameRu" name="expReasonNameRu" type="text" class="form-control"></textarea>
                                    </div>
                                    <div class="col-lg-6">
                                        <label class="control-label">Основание на казахском языке*</label>
                                        <textarea rows="4" id="expReasonNameKz" name="expReasonNameKz" type="text" class="form-control"></textarea>
                                    </div>
                                </div>
                                <div id="displayShow" style="display: block">
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label class="control-label">Наименование на русском языке*</label>
                                            <textarea rows="5" id="expProNameRu" name="expProNameRu" type="text" class="form-control"></textarea>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="control-label">Наименование на казахском языке*</label>
                                            <textarea rows="5" id="expProNameKz" name="expProNameKz" type="text" class="form-control"></textarea>
                                        </div>
                                    </div>
                                    @*<div class="form-group">
                                        <div class="col-lg-11">
                                            <label class="control-label">НД</label>
                                            @Html.DropDownList("NomenclatureId", (IEnumerable<SelectListItem>)ViewData["UObkNomenclature"],
                                                String.Empty, new { @class = "form-control" })
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label class="control-label"></label>
                                            <textarea id="nomenclatureNameRu" name="nomenclatureNameRu" type="text" class="form-control"></textarea>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="control-label"></label>
                                            <textarea id="nomenclatureNameKz" name="nomenclatureNameKz" type="text" class="form-control"></textarea>
                                        </div>
                                    </div>*@
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label class="control-label">Доп. информация на русском языке</label>
                                            <textarea id="addInfoExpertiseRu" name="addInfoExpertiseRu" type="text" class="form-control"></textarea>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="control-label">Доп. информация на казахском языке</label>
                                            <textarea id="addInfoExpertiseKz" name="addInfoExpertiseKz" type="text" class="form-control"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label class="control-label">№ заключения*</label>
                                            <input id="expConclusionNumber" name="expConclusionNumber" type="text" class="form-control">
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="control-label">№ бланка*</label>
                                            <input id="expBlankNumber" name="expBlankNumber" type="text" class="form-control">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label class="control-label">Тип заключения</label><br />
                                            <input type="radio" name="radiobutton" checked="checked" id="expNotApplication" onchange="hide()"> без приложения
                                            <input type="radio" name="radiobutton" id="expApplication" onchange="show()"> с приложением
                                        </div>
                                        <div class="col-lg-6" id="expApplicationNumber" style="display:none">
                                            <label class="control-label">№ бланка приложения</label>
                                            <input id="expApplicationNumber1" name="expApplicationNumber" type="text" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="saveButtonId" style="display: block">
                    <button type="button" style="margin: 10px" class="btn btn-default" onclick="saveExpDoc()"><span class="pwToolbarButtonSave"></span><span class="pwToolbarButtonTitle">Сохранить</span></button>
                </div>
            </div>

        </div>
    </div>
</div>

<!--валидация-->
<script type="text/javascript">

    var productSeriesId = null;
    var tabRow = null;

    function setDateFormat(control) {
        $(control).datepicker({
            dateFormat: 'dd.mm.yy',
            language: 'ru',
            autoclose: true
        });
    }

    $(document).ready(function() {
        setDateFormat(".date-control");
        $('#tableExpertiseProducts_@modelId').DataTable({
            language: {
                url: "/Content/json/Russian.json"
            },
            data: null,
            searching: false,
            "bLengthChange": false,
            columns: [
                { title: "", sWidth: "3%" },
                { title: "Наименование", sWidth: "32%" },
                { title: "Производитель", sWidth: "32%" },
                { title: "Страна-производитель", sWidth: "13%" },
                { title: "ТН ВЭД", sWidth: "10%" },
                { title: "КП ВЭД", sWidth: "10%" }
            ]
        });

        $('#tableExpertiseProductSeries_@modelId').DataTable({
            language: {
                url: "/Content/json/Russian.json"
            },
            data: null,
            searching: false,
            "bLengthChange": false,
            columns: [
                { title: "Номер серии" },
                { title: "Результат" },
                { title: "№ заключения" },
                { title: "Срок действия" }
            ]
        });

        showRows(false);
        getContract();
    });

    function showRows(bool) {
        if (bool) {
            document.getElementById('resultRowId').style.display = 'block';
            document.getElementById('saveButtonId').style.display = 'block';
        } else {
            document.getElementById('resultRowId').style.display = 'none';
            document.getElementById('saveButtonId').style.display = 'none';
        }
    }
    function show() {
        document.getElementById('expApplicationNumber').style.display = 'block';
    }
    function hide() {
        document.getElementById('expApplicationNumber').style.display = 'none';
    }

    $("#ExpertiseResult").change(function() {
        var selectedExpertiseResult = $(this).val();
        if (selectedExpertiseResult === "False") {
            document.getElementById('displayShow').style.display = 'none';
        }
        if (selectedExpertiseResult === "True") {
            document.getElementById('displayShow').style.display = 'block';
        } else if (selectedExpertiseResult === "") {
            document.getElementById('displayShow').style.display = 'none';
        }
        if (selectedExpertiseResult !== "") {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetReasons")',
                data: { expResult: selectedExpertiseResult },
                dataType: 'json',
                cache: false,
                success: function(resultData) {
                    var reasonSelect = $("#ReasonResult");
                    reasonSelect.empty();
                    reasonSelect.append(
                        $('<option/>')
                        .attr('value', "")
                        .text("")
                    );
                    $.each(resultData,
                        function(index, result) {
                            reasonSelect.append(
                                $('<option/>')
                                .attr('value', result.NameKz)
                                .text(result.NameRu)
                            );
                        });
                }
            });
        }
    });

    function rowClear() {
        $("#ExpertiseResult").val("");
        $("#ReasonResult").val("");
        $("#expertiseEndDate").val("");
        $("#expReasonNameRu").val("");
        $("#expReasonNameKz").val("");
        $("#expConclusionNumber").val("");
        $("#expBlankNumber").val("");
        $("#expApplicationNumber1").val("");
        hide();
    }

    $("#ReasonResult").change(function() {
        $("#expReasonNameRu").val($(this).find(":selected").text());
        $("#expReasonNameKz").val($(this).find(":selected").val());
    });

    function invoice() {
        var dogovorRu = "";
        var invoiceRu = "";
        var invoiceDateRu = "";
        var dogovorKz = "";
        var invoiceKz = "";
        var invoiceDateKz = "";
        if ("@invoiceContractRu" !== " ") {
            dogovorRu = ("Договора поставки " + "@invoiceContractRu");
        }
        if ("@invoiceRu" !== " ") {
            invoiceRu = (" инвойс " + "@invoiceRu");
        }
        if ("@invoiceDate" !== " ") {
            invoiceDateRu = (" дата инвойса " + "@invoiceDate");
            invoiceDateKz = (" инвойс күні " + "@invoiceDate");
        }
        if ("@invoiceContractKz" !== " ") {
            dogovorKz = ("Жеткізу шарты " + "@invoiceContractKz");
        }
        if ("@invoiceKz" !== " ") {
            invoiceRu = (" инвойс " + "@invoiceRu");
        }
        if ("@invoiceKz" !== " ") {
            invoiceKz = (" инвойс " + "@invoiceKz");
        }
        $("#addInfoExpertiseRu").val(dogovorRu + invoiceRu + invoiceDateRu);
        $("#addInfoExpertiseKz").val(dogovorKz + invoiceKz + invoiceDateKz);
    }

    function rowCallback(row) {
        $('td', row).unbind('click');
        $('td', row).bind('click',
            function() {
                var tab = $(this.parentNode.parentNode.parentNode).DataTable();
                tab.$('tr.pw-row-selected').removeClass('pw-row-selected');
                rowClear();
                debugger;
                $(this.parentNode).addClass('pw-row-selected');
                var mass = tab.row('.pw-row-selected').data();
                tabRow = mass;
                $("#tableExpertiseProductSeries_@modelId").DataTable({
                    language: {
                        url: "/Content/json/Russian.json"
                    },
                    data: mass.OBK_Procunts_Series,
                    destroy: true,
                    searching: false,
                    LengthMenu: false,
                    iDisplayLength: 5,
                    bLengthChange: false,
                    rowCallback: rowCallbackSeries,
                    columns: [
                        {
                            data:  function (data) {
                                return data.Series + ", годен до " + data.SeriesEndDate + ", партия " + data.SeriesParty + " " + data.SeriesShortNameRu;
                            }
                        },
                        { data: "ExpResultTitle", defaultContent: "<i>нет данных</i>" },
                        { data: "ExpConclusionNumber", defaultContent: "<i>нет данных</i>" },
                        { data: "ExpEndDate", defaultContent: "<i>нет данных</i>" }
                    ]
                });
                showRows(false);

                function rowCallbackSeries(rowSeries) {
                    $('td', rowSeries).unbind('click');
                    $('td', rowSeries).bind('click',
                        function() {
                            var tabSeries = $(this.parentNode.parentNode.parentNode).DataTable();
                            tabSeries.$('tr.pw-row-selected').removeClass('pw-row-selected');
                            rowClear();
                            $(this.parentNode).addClass('pw-row-selected');
                            var massSeries = tabSeries.row('.pw-row-selected').data();
                            showRows(true);
                            debugger;
                            // если на серию
                            if (massSeries.ProductSeriesId != null) {
                                productSeriesId = massSeries.Id;
                                $("#ExpertiseResult").val(massSeries.ExpResult);
                                $("#expertiseStartDate").val(massSeries.ExpStartDate);
                                $("#expertiseEndDate").val(massSeries.ExpEndDate);

                                $("#expReasonNameRu").val(massSeries.ExpReasonNameRu);
                                $("#expReasonNameKz").val(massSeries.ExpReasonNameKz);
                                $("#expProNameRu").val(massSeries.ExpProductNameRu);
                                $("#expProNameKz").val(massSeries.ExpProductNameKz);

                                $("#nomenclatureNameRu").val(massSeries.ExpNomenclatureRu);
                                $("#nomenclatureNameKz").val(massSeries.ExpNomenclatureKz);
                                $("#addInfoExpertiseRu").val(massSeries.ExpAddInfoRu);
                                $("#addInfoExpertiseKz").val(massSeries.ExpAddInfoKz);
                                $("#expConclusionNumber").val(massSeries.ExpConclusionNumber);
                                $("#expBlankNumber").val(massSeries.ExpBlankNumber);
                                if (massSeries.ExpApplication)
                                    show();
                                else
                                    hide();
                                $("#expApplicationNumber1").val(massSeries.ExpApplicationNumber);
                            } else {
                                productSeriesId = massSeries.Id;
                                invoice();
                                $("#expertiseEndDate").val(massSeries.SeriesEndDate);
                                $("#expProNameRu").val(mass.NameRu + ", серия " + massSeries.Series + ", годен до " + massSeries.SeriesEndDate + ", партия " + massSeries.SeriesParty + " " + massSeries.SeriesShortNameRu);
                                $("#expProNameKz").val(mass.NameKz + ", " + massSeries.Series + " сериясы, сақтау мерзімі " + massSeries.SeriesEndDate + " ж., партия " + massSeries.SeriesParty + " " + massSeries.SeriesShortNameRu);
                            }
                        });
                    return rowSeries;
                }
            });
        return row;
    }

    @*function test2() {
        var test = $('#tableExpertiseProducts_@modelId').DataTable();
        var test1 = test.row('.pw-row-selected').data();
    }*@

    @*function getFind(result) {
        if (tabRow != null) {
            var res = $.grep(result,
                function (item) {
                    if (item.Id === tabRow.Id)
                        return item;
                });
            $("#tableExpertiseProductSeries_@modelId").DataTable({
                language: {
                    url: "/Content/json/Russian.json"
                },
                data: res.OBK_Procunts_Series,
                destroy: true,
                searching: false,
                LengthMenu: false,
                iDisplayLength: 5,
                bLengthChange: false,
                columns: [
                    {
                        //data: Series + ", годен до " + SeriesEndDate + ", партия " + SeriesParty + " " + SeriesShortNameRu
                        //    function (data) {
                        //    debugger;
                        //    return data.Series + ", годен до " + data.SeriesEndDate + ", партия " + data.SeriesParty + " " + data.SeriesShortNameRu;
                        //}
                    },
                    { data: "ExpResultTitle", defaultContent: "<i>нет данных</i>" },
                    { data: "ExpConclusionNumber" , defaultContent: "<i>нет данных</i>" },
                    { data: "ExpEndDate", defaultContent: "<i>нет данных</i>" }
                ]
            });
        }
    }*@

    function getContract() {
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetContract")',
            data: { 'id': '@Model.Contract_Id' },
            dataType: 'json',
            cache: false,
            success: function(data) {
                if (data.isSuccess) {
                    $("#tableExpertiseProducts_@modelId").DataTable({
                        language: {
                            url: "/Content/json/Russian.json"
                        },
                        data: data.result.ObkRsProductses,
                        destroy: true,
                        searching: false,
                        iDisplayLength: 5,
                        LengthMenu: false,
                        bLengthChange: false,
                        autoWidth: true,
                        rowCallback: rowCallback,
                        columns: [
                            { data: "Id" },
                            { data: "NameRu" },
                            { data: "ProducerNameRu" },
                            { data: "CountryNameRu" },
                            { data: "TnvedCode" },
                            { data: "KpvedCode" }
                        ]
                    });
                    //debugger;
                    //getFind(data.result.ObkRsProductses);
                }
            },
            error: function() {
                alert("Connection Failed. Please Try Again");
            }
        });
    }

    function saveExpDoc() {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetSaveExpDoc")',
            data: {
                prodSeriesId: productSeriesId,
                expResult: $("#ExpertiseResult").val(),
                expStartDate: $("#expertiseStartDate").val(),
                expEndDate: $("#expertiseEndDate").val(),
                expReasonNameRu: $("#expReasonNameRu").val(),
                expReasonNameKz: $("#expReasonNameKz").val(),
                expProNameRu: $("#expProNameRu").val(),
                expProNameKz: $("#expProNameKz").val(),
                expNomenclatureRu: $("#nomenclatureNameRu").val(),
                expNomenclatureKz: $("#nomenclatureNameKz").val(),
                addInfoExpertiseRu: $("#addInfoExpertiseRu").val(),
                addInfoExpertiseKz: $("#addInfoExpertiseKz").val(),
                expConclusionNumber: $("#expConclusionNumber").val(),
                expBlankNumber: $("#expBlankNumber").val(),
                expApplicationNumber: $("#expApplicationNumber1").val()
            },
            dataType: 'json',
            cache: false,
            success: function (data) {
                if (data.isSuccess) {
                    alert("OK!");
                    getContract();
                } else { alert("Error!"); }
            },
            error: function() {
                alert("Connection Failed. Please Try Again");
            }
        });
    }
</script>

